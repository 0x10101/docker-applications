var amqp = require("amqp-ts");
var moment = require('moment');

var host = process.env.AMQP_HOST || "rabbitmq";
var port = process.env.AMQP_PORT || 5672;
var exchangeName = process.env.AMQP_EXCHANGE || "exchange";
var queueName = process.env.AMQP_QUEUE || "queue";

// [0]date, [0]time, [2]low(Hz), [3]high(Hz), [4]step(Hz), [5]samples, dB, dB, dB, ...
var data = "2016-04-28, 13:17:00, 26000000, 28796874, 2731.32, 8, -43.09, -35.04, -27.31, -39.44, -44.39, -47.04, -48.11, -46.69, -46.42, -47.97, -48.93, -46.77, -47.36, -45.96, -51.22, -43.99, -48.83, -47.30, -46.72, -47.52, -49.42, -47.72, -47.96, -48.54, -49.17, -47.69, -48.50, -48.76, -47.37, -49.23, -45.83, -46.54, -46.26, -50.19, -46.05, -45.90, -45.30, -47.55, -44.99, -46.97, -47.73, -47.15, -49.23, -46.84, -49.75, -51.40, -44.56, -44.06, -44.09, -45.77, -44.69, -46.71, -43.74, -46.81, -43.45, -42.42, -43.57, -42.99, -44.01, -42.26, -44.13, -42.85, -44.52, -41.46, -43.52, -41.38, -42.38, -43.08, -42.34, -43.15, -40.72, -45.12, -44.45, -42.98, -42.19, -42.64, -43.09, -42.59, -43.13, -43.36, -45.30, -41.03, -46.67, -45.77, -43.48, -44.38, -42.94, -44.63, -42.59, -43.42, -45.93, -42.01, -43.30, -42.95, -43.47, -43.94, -44.27, -44.34, -43.53, -44.99, -42.55, -42.76, -42.77, -42.41, -42.60, -43.85, -42.77, -42.03, -46.37, -43.55, -44.41, -41.83, -41.04, -41.50, -31.95, -40.38, -42.01, -42.18, -43.55, -42.47, -44.26, -42.54, -42.06, -42.81, -40.98, -40.56, -42.86, -39.94, -42.10, -45.31, -43.07, -43.54, -41.56, -42.83, -42.78, -43.01, -47.20, -44.97, -40.90, -39.96, -42.78, -40.31, -40.98, -42.23, -43.97, -43.64, -44.71, -40.18, -43.15, -40.72, -42.10, -43.45, -40.67, -41.04, -40.87, -42.67, -41.61, -40.40, -40.20, -42.31, -40.48, -43.48, -40.10, -42.03, -42.33, -38.33, -41.01, -40.24, -42.22, -40.04, -42.67, -39.34, -41.66, -40.98, -42.90, -40.99, -39.74, -39.91, -31.52, -33.41, -38.15, -38.19, -41.76, -42.76, -39.80, -39.67, -41.48, -42.76, -40.39, -38.38, -44.07, -40.13, -42.29, -39.03, -43.58, -39.82, -41.48, -40.80, -40.60, -39.91, -41.35, -38.83, -40.35, -39.60, -37.49, -42.47, -38.58, -40.13, -42.43, -41.31, -40.05, -39.89, -42.51, -37.22, -40.56, -43.21, -41.37, -41.72, -39.54, -39.84, -44.27, -41.46, -39.13, -34.86, -39.22, -37.43, -41.44, -38.92, -39.14, -40.67, -41.88, -38.91, -40.47, -42.06, -40.00, -39.79, -39.09, -40.14, -39.03, -46.28, -41.03, -41.14, -36.98, -32.45, -43.98, -40.75, -38.24, -41.48, -39.86, -40.96, -40.74, -40.98, -41.81, -39.86, -41.65, -40.96, -41.24, -39.19, -43.10, -41.80, -39.66, -39.62, -44.35, -40.48, -46.96, -41.75, -40.98, -41.45, -41.28, -39.64, -40.90, -39.74, -40.67, -43.76, -41.66, -43.57, -39.76, -42.22, -40.80, -42.02, -42.92, -40.22, -42.91, -39.69, -41.19, -43.66, -39.12, -39.20, -40.90, -40.53, -40.17, -42.92, -38.86, -42.03, -41.87, -39.80, -42.54, -40.56, -40.55, -42.49, -41.71, -44.23, -43.94, -40.64, -42.09, -41.13, -38.87, -34.31, -35.72, -35.72, -40.09, -39.51, -38.04, -40.86, -41.29, -42.46, -43.64, -41.94, -41.22, -44.14, -41.54, -40.64, -42.43, -41.35, -40.30, -42.61, -42.11, -41.02, -43.09, -39.43, -42.34, -41.58, -43.93, -40.47, -41.69, -41.18, -39.18, -40.74, -43.21, -41.09, -42.71, -35.80, -41.79, -39.48, -38.44, -44.22, -41.59, -42.46, -41.23, -43.00, -37.86, -40.92, -40.54, -42.81, -40.68, -38.10, -40.63, -39.42, -40.04, -39.00, -38.18, -40.04, -42.90, -37.28, -38.73, -38.90, -37.54, -35.87, -34.15, -31.41, -30.47, -25.70, -14.44, -17.39, -25.88, -29.93, -32.55, -33.58, -34.55, -33.95, -36.06, -34.66, -34.10, -35.43, -35.51, -36.53, -37.77, -34.99, -37.19, -36.43, -33.84, -34.18, -37.24, -38.40, -36.85, -34.64, -37.67, -35.63, -39.59, -37.63, -36.41, -39.53, -36.91, -39.65, -39.57, -34.69, -37.54, -36.91, -38.94, -38.32, -39.95, -39.33, -40.24, -37.33, -41.92, -40.67, -34.30, -39.57, -40.16, -41.03, -40.39, -37.06, -37.63, -37.30, -38.79, -38.32, -35.25, -40.22, -40.90, -37.90, -40.05, -36.72, -38.04, -37.85, -36.78, -36.07, -32.04, -36.73, -33.88, -40.06, -37.16, -38.49, -38.58, -37.27, -37.93, -40.34, -40.63, -40.14, -41.18, -40.01, -40.80, -40.25, -42.91, -40.36, -42.14, -39.46, -42.65, -41.54, -40.74, -42.60, -40.59, -41.77, -39.52, -40.68, -40.80, -41.48, -41.59, -40.12, -40.54, -39.25, -39.05, -39.78, -40.55, -40.51, -40.21, -43.99, -38.74, -41.99, -42.85, -42.72, -44.86, -40.54, -41.84, -40.06, -41.47, -41.31, -41.70, -38.92, -39.51, -39.61, -42.36, -41.31, -40.81, -39.82, -41.10, -40.45, -40.17, -40.71, -39.75, -40.16, -38.77, -37.58, -37.17, -39.79, -40.66, -36.95, -43.93, -39.19, -40.40, -38.25, -39.17, -41.34, -40.84, -40.84, -40.49, -42.48, -41.72, -40.91, -39.10, -41.35, -36.79, -41.96, -40.68, -40.69, -40.73, -40.58, -40.20, -39.62, -42.70, -40.42, -41.18, -40.79, -42.47, -40.39, -38.58, -40.26, -37.99, -37.79, -40.96, -41.73, -39.47, -37.22, -38.61, -40.78, -40.35, -40.20, -39.84, -42.68, -40.36, -38.93, -40.64, -39.52, -43.86, -43.81, -44.79, -40.58, -39.38, -40.84, -38.89, -37.50, -41.38, -41.68, -41.37, -37.37, -34.73, -36.27, -36.15, -31.16, -40.39, -40.10, -39.32, -41.46, -41.24, -40.61, -40.49, -40.46, -39.63, -41.19, -39.50, -40.27, -42.70, -40.10, -38.84, -41.29, -42.37, -41.29, -40.72, -38.96, -44.39, -41.50, -42.12, -37.68, -40.60, -40.76, -44.54, -40.41, -39.49, -40.08, -41.13, -41.10, -39.95, -42.95, -42.03, -42.35, -39.81, -40.53, -45.28, -40.24, -39.74, -43.06, -45.32, -40.61, -40.41, -44.88, -40.89, -43.08, -41.88, -42.04, -39.97, -40.44, -44.81, -38.59, -41.46, -39.21, -38.66, -38.37, -38.14, -41.19, -42.66, -41.06, -39.57, -32.71, -36.99, -41.83, -40.28, -41.66, -40.37, -40.45, -42.99, -43.95, -39.34, -40.86, -43.59, -41.13, -42.55, -40.87, -40.91, -42.05, -41.81, -42.72, -43.17, -41.25, -43.84, -41.94, -40.14, -41.18, -41.83, -40.25, -41.12, -42.45, -41.11, -43.87, -42.40, -45.12, -41.34, -44.08, -42.26, -41.09, -41.97, -40.15, -40.22, -41.63, -41.27, -40.65, -43.82, -38.85, -40.23, -42.96, -43.60, -41.38, -41.97, -41.79, -41.65, -41.37, -40.30, -43.08, -41.25, -41.04, -42.85, -40.62, -43.39, -42.89, -40.60, -40.88, -40.20, -43.48, -40.69, -41.75, -40.75, -41.49, -42.99, -40.71, -42.85, -41.58, -39.51, -42.31, -38.70, -40.96, -42.14, -41.30, -39.32, -41.41, -40.44, -39.87, -40.07, -40.60, -41.25, -42.93, -42.54, -43.20, -42.53, -43.20, -41.78, -44.00, -42.01, -40.89, -38.71, -41.63, -41.26, -43.35, -42.34, -43.83, -45.86, -40.54, -41.33, -41.02, -44.93, -39.60, -41.80, -41.70, -42.11, -40.55, -42.84, -39.54, -42.30, -42.28, -42.50, -41.80, -42.35, -44.82, -43.05, -40.94, -39.31, -38.76, -41.05, -42.65, -42.71, -40.07, -40.64, -40.12, -35.01, -40.85, -37.83, -39.86, -41.24, -42.67, -42.43, -41.86, -40.85, -40.81, -42.75, -40.38, -40.91, -44.03, -41.29, -39.00, -44.60, -40.86, -39.98, -39.55, -41.61, -41.03, -42.54, -41.92, -40.80, -41.40, -39.56, -41.36, -43.70, -41.63, -41.00, -40.05, -40.84, -41.58, -43.18, -43.87, -39.66, -39.81, -42.77, -39.22, -39.40, -39.80, -37.08, -38.78, -42.50, -38.33, -39.94, -40.11, -39.93, -41.77, -43.24, -39.79, -42.44, -42.90, -40.55, -41.18, -44.54, -41.25, -41.31, -43.78, -40.50, -40.29, -42.51, -42.99, -41.29, -40.00, -37.82, -44.91, -42.17, -43.13, -41.18, -42.04, -41.52, -39.61, -47.85, -39.50, -43.51, -39.96, -40.19, -42.41, -41.64, -40.29, -46.27, -43.66, -39.22, -45.48, -44.53, -43.55, -42.17, -42.87, -43.12, -44.33, -44.41, -40.66, -42.44, -40.90, -42.16, -43.47, -40.50, -41.69, -42.60, -39.95, -42.76, -44.90, -42.58, -45.15, -43.22, -44.94, -43.17, -42.02, -41.17, -42.70, -46.89, -41.86, -43.54, -41.69, -41.94, -43.99, -41.75, -44.34, -39.85, -42.89, -44.97, -40.53, -44.32, -42.89, -40.58, -42.25, -44.25, -41.20, -43.71, -44.20, -43.65, -40.40, -42.52, -41.56, -38.58, -46.05, -43.62, -43.09, -43.55, -42.18, -41.19, -43.69, -43.70, -43.22, -44.88, -47.78, -41.02, -42.63, -43.75, -44.31, -45.37, -39.82, -41.07, -42.63, -46.94, -42.18, -42.84, -43.31, -47.00, -45.03, -44.75, -45.72, -38.26, -41.30, -43.59, -42.91, -45.19, -43.60, -45.26, -45.62, -45.44, -44.40, -45.11, -42.86, -45.28, -47.46, -46.09, -43.52, -43.81, -44.33, -44.95, -46.66, -48.31, -46.43, -45.52, -45.43, -44.97, -44.63, -43.02, -44.89, -47.32, -43.91, -48.50, -44.67, -49.17, -45.94, -46.27, -48.02, -46.00, -45.83, -47.44, -45.73, -46.22, -46.13, -47.39, -46.35, -44.58, -47.72, -50.73, -46.56, -46.47, -44.80, -47.17, -50.11, -47.82, -46.21, -45.52, -48.74, -47.70, -45.22, -33.39, -40.30, -44.55, -44.49, -48.58, -46.80, -46.63, -49.66, -49.92, -46.73, -48.06, -47.98, -46.22, -47.69, -46.49, -46.00, -46.25, -47.07, -47.31, -50.62, -47.41, -45.38, -47.71, -45.94, -49.17, -47.02, -45.46, -45.37, -46.54, -49.35, -45.90, -46.01, -50.60, -46.09, -48.87, -46.40, -44.27, -46.08, -45.76, -44.50, -45.43, -45.46, -45.99"

var connection = new amqp.Connection("amqp://"+host+":"+port);
var exchange = connection.declareExchange(exchangeName);
var queue = connection.declareQueue(queueName);
queue.bind(exchange);

// CREATE DATABASE rtl_power
// CREATE USER rtl_power WITH PASSWORD 'rtl_power'
// GRANT READ ON rtl_power TO rtl_power
// GRANT WRITE ON rtl_power TO rtl_power
var influxdb = require('influx')
var client = influxdb({host: 'influxdb', username: 'rtl_pwoer', password: 'rtl_pwoer', database: 'rtl_power'})
client.dropDatabase('rtl_power', function (err) { if (err) throw err; console.log('Database droppped') })
client.createDatabase('rtl_power', function (err) { if (err) throw err; console.log('Database Created') })

queue.activateConsumer((message) => {
  var content = message.getContent()
   console.log("msg: "  + content);

   var data = content.split(",");

   var date = data[0];
   var time = data[1];
   var low_hz = parseInt(data[2]);
   var high_hz = parseInt(data[3]);
   var step_hz = parseFloat(data[4]);
   var samples = parseInt(data[5]);
     
   var dbs = data.splice(6,data.length);
   var dateTime = moment(date+time, "YYYY-MM-DD HH:mm:ss Z", "nl");

   for(var i=0; i<dbs.length; i++) {
     var points = [
       [{value:dbs[i].trim()},{metric:'db'}],
       [{value:Math.round((low_hz + (i*step_hz)))},{metric:'freq'}],
     ]

     client.writePoints("rtl_power", points, function(err) { if (err) { console.log("Cannot write data: ", err); process.exit(1); } });
     console.log("rtl_power freq=" +Math.round((low_hz + (i*step_hz))) + ",value="+dbs[i].trim() + " " + dateTime);
   } 

})
 
connection.completeConfiguration().then(() => {
    var msg2 = new amqp.Message(data);
    exchange.send(msg2);
});
