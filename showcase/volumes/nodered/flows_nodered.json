[{"id":"97f270ed.0e384","type":"tab","label":"Receive TTN messages"},{"id":"d7640cc9.18deb","type":"tab","label":"Decode to observations"},{"id":"52ba9841.7af4c8","type":"tab","label":"Log observations"},{"id":"be490f86.19595","type":"tab","label":"Process observations"},{"id":"2acfce56.22a7b2","type":"tab","label":"Process alerts"},{"id":"6e2fec04.b5dce4","type":"tab","label":"TTN test messages"},{"id":"ed3b0860.c759b8","type":"mqtt-broker","z":"","broker":"staging.thethingsnetwork.org","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":""},{"id":"cbe500ee.718ca","type":"MySQLdatabase","z":"","host":"mysql","port":"3306","db":"showcase","tz":""},{"id":"b3c7fccb.6d8ba","type":"telegram bot","z":"","botname":"sparky","usernames":"[]","chatids":"[]"},{"id":"62d11e19.37f06","type":"amqp-server","z":"","host":"rabbitmq","port":"5672","vhost":"","keepalive":"30","usetls":false,"verifyservercert":true,"usetopology":false,"topology":"{\n\t\"exchanges\": [\n\t\t{\"name\": \"showcase.ttn_message\", \"type\": \"fanout\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.observation\", \"type\": \"fanout\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.logged_observation\", \"type\": \"fanout\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.alert\", \"type\": \"fanout\", \"options\": {\"durable\": true}}\t\t\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"showcase.ttn_message.decode\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.observation.log\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.heartbeat.process\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.logged_observation.process\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.alert.process\", \"options\": {\"durable\": true}}\t\t\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"showcase.ttn_message\", \"queue\": \"showcase.ttn_message.decode\"},\n\t\t{\"source\": \"showcase.observation\", \"queue\": \"showcase.observation.log\"},\n\t\t{\"source\": \"showcase.logged_observation\", \"queue\": \"showcase.logged_observation.process\"},\n\t\t{\"source\": \"showcase.alert\", \"queue\": \"showcase.alert.process\"}\t\t\n\t]\n}"},{"id":"842e249a.6df468","type":"mqtt in","z":"97f270ed.0e384","name":"TTN exchange receiver","topic":"#","qos":"1","broker":"ed3b0860.c759b8","x":117,"y":85,"wires":[["61931666.dd1188","e82049c8.da6688"]]},{"id":"61931666.dd1188","type":"debug","z":"97f270ed.0e384","name":"","active":true,"console":"false","complete":"true","x":364,"y":156,"wires":[]},{"id":"e82049c8.da6688","type":"amqp out","z":"97f270ed.0e384","name":"","routingkey":"","iotype":"1","ioname":"showcase.ttn_message","server":"62d11e19.37f06","x":421,"y":86,"wires":[]},{"id":"c845a32f.27b4a","type":"mysql","z":"52ba9841.7af4c8","mydb":"cbe500ee.718ca","name":"","x":614,"y":37,"wires":[["f812c2f4.fa6b3","2d2ed768.555b38"]]},{"id":"3234b502.94134a","type":"function","z":"52ba9841.7af4c8","name":"log observation in MySQL","func":"var observationTimestamp = msg.payload.timestamp.slice(0, 19).replace('T', ' '); // new Date().toISOString().slice(0, 19).replace('T', ' ')\nvar nodeId = msg.payload.nodeId;\nvar sensorId = msg.payload.sensorId;\nvar sensorValue = msg.payload.sensorValue;\nvar sensorError = msg.payload.sensorError;\n\n// todo: insert sensorError into observation table\nmsg.topic = \n     \"INSERT INTO observatie ( \" +\n         \"datum_tijd_aangemaakt,\" +\n         \"node,\" +\n         \"sensor,\" +\n         \"waarde) \" +\n     \"VALUES (\" +\n        \"'\" + observationTimestamp +\"',\" +\n        \"'\" + nodeId + \"',\" +\n        sensorId + \", \" + \n        \"'\" + sensorValue + \"'\" +\n     \");\";\nmsg.originalPayload = msg.payload;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":401,"y":37,"wires":[["c845a32f.27b4a","5ab80c23.bb2de4"]]},{"id":"3411915c.dce96e","type":"amqp in","z":"d7640cc9.18deb","name":"","topic":"","iotype":"1","ioname":"showcase.ttn_message","server":"62d11e19.37f06","x":128.5,"y":68.14999389648438,"wires":[["dec2638d.07dec","4cfb12d3.f3270c"]]},{"id":"b9aa12db.d2e8a","type":"amqp in","z":"52ba9841.7af4c8","name":"","topic":"","iotype":"1","ioname":"showcase.observation","server":"62d11e19.37f06","x":119.5,"y":37.149993896484375,"wires":[["3234b502.94134a","9f1c1e20.93e1b"]]},{"id":"dec2638d.07dec","type":"debug","z":"d7640cc9.18deb","name":"raw message","active":true,"console":"false","complete":"payload","x":342.5,"y":115.29998779296875,"wires":[]},{"id":"f812c2f4.fa6b3","type":"debug","z":"52ba9841.7af4c8","name":"log observation","active":false,"console":"false","complete":"true","x":799.5,"y":88.29998779296875,"wires":[]},{"id":"dfa94d.578eb6b","type":"function","z":"d7640cc9.18deb","name":"decode to observations","func":"//decode msg.payload.payload with protobuf\n\n// using npm module protocol-buffers (globally installed on server)\n// see: https://www.npmjs.com/package/protocol-buffers\nvar protoBufMsg = context.get(\"protoBufMsg\");\nif (protoBufMsg === undefined) {\n    var fs = global.get(\"fs\");\n    var protoBuf = global.get(\"protoBuf\");\n    protoBufMsg = protoBuf(fs.readFileSync(\"/node-red-data/sensor.proto\"));\n    context.set(\"protoBufMsg\", protoBufMsg);\n}\n\nvar payload = new Buffer(msg.payload.payload, 'base64');\n\nvar ttnMsg = protoBufMsg.NodeMessage.decode(payload);\n\nvar nodeId = msg.payload.dev_eui;\nvar timestamp = msg.payload.metadata[0].server_time; // todo: bepaal de correcte timestamp\n\n// expect ttnMsg to have a reading property that contains an array of objects\n// each object contains the properties defined in sensor.proto SensorReading\nvar reading = ttnMsg.reading;\n\n// send all sensor values as separate msg's\nfor (var len = reading.length, i=0; i < len; i++) {\n    node.send({\n        topic: \"sensor observation\",\n        payload: {\n            nodeId: nodeId,\n            sensorId: reading[i].id,\n            sensorValue: reading[i].value1,\n            sensorError: reading[i].error,\n            timestamp: timestamp\n        }\n    });\n}\n\n// check for skipped messages\nvar msgSkippedSensorId = -1;\nvar msgCounters = context.get(\"messageCounters\") || {};\nvar currentCount = msg.payload.counter;\nvar lastCount = msgCounters[nodeId] || currentCount - 1;\nvar skippedCount = currentCount - lastCount - 1;\n// node.warn(\"Message count: \" + currentCount + \" previous count: \" + lastCount + \" skipped: \" + skippedCount);\nif (skippedCount) {\n    node.send({\n        topic: \"sensor observation\",\n        payload: {\n            nodeId: nodeId,\n            sensorId: msgSkippedSensorId,\n            sensorValue: skippedCount,\n            sensorError: 0,\n            timestamp: timestamp\n        }\n    });\n}\nmsgCounters[nodeId] = currentCount;\ncontext.set(\"messageCounters\", msgCounters);\n\n// always notify that node is still alive (in a clean msg)\nreturn {\n        topic: \"sensor observation\",\n        payload: {\n          nodeId: nodeId,\n          sensorId: 0,\n          sensorValue: 1,\n          timestamp: timestamp\n        }\n    };\n","outputs":1,"noerr":0,"x":515.5,"y":68.449951171875,"wires":[["5b1d268c.b053a8"]]},{"id":"5b1d268c.b053a8","type":"amqp out","z":"d7640cc9.18deb","name":"","routingkey":"","iotype":"1","ioname":"showcase.observation","server":"62d11e19.37f06","x":759.5,"y":68.29995727539062,"wires":[]},{"id":"5ab80c23.bb2de4","type":"debug","z":"52ba9841.7af4c8","name":"","active":false,"console":"false","complete":"true","x":602.5,"y":87.29998779296875,"wires":[]},{"id":"2d2ed768.555b38","type":"function","z":"52ba9841.7af4c8","name":"add observation id","func":"var observationId = msg.payload.insertId;\nvar payload = msg.originalPayload;\npayload.id = observationId;\n\nmsg = {\n    topic: \"logged observation\",\n    payload: payload\n}\nreturn msg;","outputs":1,"noerr":0,"x":808.5,"y":37.43999481201172,"wires":[["3cd3f3c.0ba0b0c","2be57a32.94ff16"]]},{"id":"3cd3f3c.0ba0b0c","type":"amqp out","z":"52ba9841.7af4c8","name":"","routingkey":"","iotype":"1","ioname":"showcase.logged_observation","server":"62d11e19.37f06","x":1074.5,"y":37.29999542236328,"wires":[]},{"id":"2be57a32.94ff16","type":"debug","z":"52ba9841.7af4c8","name":"","active":false,"console":"false","complete":"false","x":1013.5,"y":87.30000305175781,"wires":[]},{"id":"469c457d.abc18c","type":"amqp in","z":"be490f86.19595","name":"","topic":"","iotype":"1","ioname":"showcase.logged_observation","server":"62d11e19.37f06","x":143.5,"y":74.14999389648438,"wires":[["82c9210e.093f4"]]},{"id":"82c9210e.093f4","type":"function","z":"be490f86.19595","name":"haal alarmregels","func":"msg.originalPayload = msg.payload;\nmsg.topic = \"SELECT id, alarm_trigger FROM alarm_regel WHERE \" +\n    \"node = '\" + msg.payload.nodeId + \"'\" +\n    \" AND \" +\n    \"sensor = \" + msg.payload.sensorId + \";\";\nreturn msg;","outputs":1,"noerr":0,"x":386.5,"y":74.44999694824219,"wires":[["801977fa.c23ed8"]]},{"id":"801977fa.c23ed8","type":"mysql","z":"be490f86.19595","mydb":"cbe500ee.718ca","name":"","x":565,"y":74,"wires":[["76a96778.5456b8","bac44cbb.b4b28"]]},{"id":"76a96778.5456b8","type":"function","z":"be490f86.19595","name":"check alarmregels","func":"var safeEval = global.get(\"safeEval\");\n\nvar rules = msg.payload;\nvar observation = msg.originalPayload;\nvar value = observation.sensorValue;\n\nfunction sendAlert(rule) {\n    var alertMsg = {\n        topic: \"rule alert\",\n        payload: {\n            nodeId: observation.nodeId,\n            sensorId: observation.sensorId,\n            sensorValue: observation.sensorValue,\n            observationId: observation.id,\n            ruleId: rule.id\n        }\n    }\n    node.send(alertMsg)    \n}\n\nfunction timeoutAlert(rule) {\n    delete heartbeatTimers[rule.id];\n    sendAlert(rule);\n}\n\nif (observation.sensorId === 0) {\n    // sensor 0 is the heartbeat, setup timeout(s)\n    var heartbeatTimers = context.get(\"heartbeatTimers\") || {};\n    for (var len = rules.length, i = 0; i < len; i++) {\n        // stop running timer\n        var timer = heartbeatTimers[rules[i].id];\n        // reset heartbeat timeout timer\n        if (timer) {\n            clearTimeout(timer);\n        }\n        var timeoutSeconds = Number(rules[i].alarm_trigger);\n        if (!isNaN(timeoutSeconds)) {\n            timer = setTimeout(timeoutAlert, timeoutSeconds * 1000, rules[i]);\n            heartbeatTimers[rules[i].id] = timer;            \n        }\n    }\n    context.set(\"heartbeatTimers\", heartbeatTimers);\n} else if (!observation.sensorError) {\n    // evaluate alarm_trigger(s)\n    for (var len = rules.length, i = 0; i < len; i++) {\n        try {\n            var evalContext = {\n                X: value,\n                x: value\n            };\n            var result = safeEval(rules[i].alarm_trigger, evalContext);\n            // node.warn(\"rule evaluation for rule \" + rules[i].id +\n            //     \" on state '\" + rules[i].alarm_trigger + \"', with x = \" + value + \" returns \" + result);\n            if (result) {\n                sendAlert(rules[i]);\n            }\n        } catch (err) {\n            // todo: log rule evaluation error\n            node.error(\"rule evaluation error for rule \" + rules[i].id +\n                \" on state '\" + rules[i].alarm_trigger + \"', with x = \" + value);\n        }\n    }\n}\n","outputs":1,"noerr":0,"x":759.5,"y":74.44999694824219,"wires":[["f2f4ca99.9581a8","c648babe.a6ad08"]]},{"id":"f2f4ca99.9581a8","type":"amqp out","z":"be490f86.19595","name":"","routingkey":"","iotype":"1","ioname":"showcase.alert","server":"62d11e19.37f06","x":972.5,"y":74.30000305175781,"wires":[]},{"id":"bac44cbb.b4b28","type":"debug","z":"be490f86.19595","name":"","active":false,"console":"false","complete":"payload","x":740.5,"y":124.29998779296875,"wires":[]},{"id":"9509f6a8.7538c8","type":"amqp in","z":"2acfce56.22a7b2","name":"","topic":"","iotype":"1","ioname":"showcase.alert","server":"62d11e19.37f06","x":108.5,"y":146.14999389648438,"wires":[["12efee9.66ad811","136f40a7.3a376f"]]},{"id":"12efee9.66ad811","type":"function","z":"2acfce56.22a7b2","name":"get alert notification actions","func":"// notification table has yet to be implemented\nmsg.topic = \n    \"SELECT kanaal, p1, p2, p3, p4, meldingtekst FROM alarm_notificatie \" +\n    \"WHERE alarm_regel = \" + msg.payload.ruleId + \";\";\nmsg.originalPayload = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":388.5,"y":125.44999694824219,"wires":[["65847d9a.9d1b34"]]},{"id":"136f40a7.3a376f","type":"function","z":"2acfce56.22a7b2","name":"log alert","func":"msg.topic = \n    \"INSERT INTO alarm ( \" +\n        \"alarm_regel,\" +\n        \"observatie) \" +\n    \"VALUES (\" +\n        msg.payload.ruleId + \",\" +\n        msg.payload.observationId + \n    \");\";\nmsg.originalPayload = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":328.5,"y":168.44998168945312,"wires":[["9b7489cf.d3c698","399aa278.659a4e"]]},{"id":"9b7489cf.d3c698","type":"mysql","z":"2acfce56.22a7b2","mydb":"cbe500ee.718ca","name":"","x":484,"y":169,"wires":[[]]},{"id":"65847d9a.9d1b34","type":"mysql","z":"2acfce56.22a7b2","mydb":"cbe500ee.718ca","name":"","x":602,"y":125,"wires":[["9b608ccd.27f3e","54d9245a.d1904c","39201c60.eea254"]]},{"id":"399aa278.659a4e","type":"debug","z":"2acfce56.22a7b2","name":"","active":false,"console":"false","complete":"false","x":491.5,"y":216.29998779296875,"wires":[]},{"id":"9f1c1e20.93e1b","type":"debug","z":"52ba9841.7af4c8","name":"","active":false,"console":"false","complete":"false","x":362.5,"y":84.29998779296875,"wires":[]},{"id":"cb6807a0.d9fd18","type":"Slack Bot Out","z":"2acfce56.22a7b2","name":"sparky (slack)","apiToken":"xoxb-63081672787-taRL39u95elfJ8ARh1gGvRUR","channel":"","x":972,"y":103,"wires":[]},{"id":"545b676c.d7ae28","type":"telegram sender","z":"2acfce56.22a7b2","name":"sparky (telegram)","bot":"b3c7fccb.6d8ba","x":1007,"y":152,"wires":[[]]},{"id":"9b608ccd.27f3e","type":"function","z":"2acfce56.22a7b2","name":"notify to Slack","func":"var notificaties = msg.payload;\nvar alert = msg.originalPayload;\n\nfor (var i=0, len = notificaties.length; i < len; i++) {\n    var notificatie = notificaties[i];\n    \n    if (notificatie.kanaal === \"slack\") {\n        var slackMsg = {\n            payload: notificatie.meldingtekst\n        };\n        if (notificatie.p1) {\n            slackMsg.channel = notificatie.p1;\n        }\n        node.send(slackMsg)\n    }\n}\n\nreturn null;\n","outputs":1,"noerr":0,"x":786,"y":103,"wires":[["cb6807a0.d9fd18"]]},{"id":"54d9245a.d1904c","type":"function","z":"2acfce56.22a7b2","name":"notify to Telegram","func":"var notificaties = msg.payload;\nvar alert = msg.originalPayload;\n\nfor (var i=0, len = notificaties.length; i < len; i++) {\n    var notificatie = notificaties[i];\n    \n    if (notificatie.kanaal === \"telegram\") {\n        node.send({\n            payload: {\n                type: \"message\",\n                content: notificatie.meldingtekst,\n                chatId: notificatie.p1\n            }\n        });\n    }\n}\n\nreturn null;","outputs":1,"noerr":0,"x":797,"y":152,"wires":[["545b676c.d7ae28"]]},{"id":"e77777ba.a5ad88","type":"inject","z":"6e2fec04.b5dce4","name":"raw TTN protobuf alive test msg","topic":"70B3D57ED0000105/devices/000000007FEE6E5B/up","payload":"{\"payload\":\"CgQIARgC\",\"port\":1,\"counter\":8,\"dev_eui\":\"000000007FEE6E5B\",\"metadata\":[{\"frequency\":868.5,\"datarate\":\"SF7BW125\",\"codingrate\":\"4/5\",\"gateway_timestamp\":2913536323,\"channel\":2,\"server_time\":\"2016-09-09T09:14:32.141349077Z\",\"rssi\":-34,\"lsnr\":6.2,\"rfchain\":1,\"crc\":1,\"modulation\":\"LORA\",\"gateway_eui\":\"0000024B0805026F\",\"altitude\":-1,\"longitude\":5.26561,\"latitude\":52.05755}]}","payloadType":"str","repeat":"","crontab":"","once":false,"x":181,"y":89,"wires":[["b3d9ed67.a49e5"]]},{"id":"7a30efb7.d38fe","type":"comment","z":"6e2fec04.b5dce4","name":"Raw base64 test messages","info":"","x":173,"y":40,"wires":[]},{"id":"b3d9ed67.a49e5","type":"amqp out","z":"6e2fec04.b5dce4","name":"","routingkey":"","iotype":"1","ioname":"showcase.ttn_message","server":"62d11e19.37f06","x":506.5,"y":193.29998779296875,"wires":[]},{"id":"c648babe.a6ad08","type":"debug","z":"be490f86.19595","name":"","active":false,"console":"false","complete":"false","x":963.5,"y":122.29998779296875,"wires":[]},{"id":"5bc3fb95.080b34","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): 23","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":0,\"sensorValue\":\"23\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":865,"y":86,"wires":[["1ae86ba7.6f57f4"]]},{"id":"1ae86ba7.6f57f4","type":"amqp out","z":"6e2fec04.b5dce4","name":"","routingkey":"","iotype":"1","ioname":"showcase.observation","server":"62d11e19.37f06","x":1232,"y":169,"wires":[]},{"id":"23d0f6b5.b2337a","type":"comment","z":"6e2fec04.b5dce4","name":"Decoded test observations","info":"","x":788,"y":38,"wires":[]},{"id":"df0afc4f.9af58","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 0 (heartbeat)","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":0,\"sensorError\":0,\"sensorValue\":\"0\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":875,"y":302,"wires":[["1ae86ba7.6f57f4"]]},{"id":"39201c60.eea254","type":"debug","z":"2acfce56.22a7b2","name":"","active":false,"console":"false","complete":"false","x":779,"y":201,"wires":[]},{"id":"ba729509.017e78","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): 2","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":0,\"sensorValue\":\"2\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":865,"y":133,"wires":[["1ae86ba7.6f57f4"]]},{"id":"13c7dae3.efce65","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): 80","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":0,\"sensorValue\":\"80\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":866,"y":179,"wires":[["1ae86ba7.6f57f4"]]},{"id":"dd0d7899.e5c0d8","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): error","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":1,\"sensorValue\":null}","payloadType":"json","repeat":"","crontab":"","once":false,"x":876,"y":228,"wires":[["1ae86ba7.6f57f4"]]},{"id":"4cfb12d3.f3270c","type":"json","z":"d7640cc9.18deb","name":"","x":320.5,"y":68.44999694824219,"wires":[["dfa94d.578eb6b"]]}]