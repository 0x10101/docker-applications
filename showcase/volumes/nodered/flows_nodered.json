[{"id":"97f270ed.0e384","type":"tab","label":"Receive TTN messages"},{"id":"95a66cfb.0120b","type":"tab","label":"Receive KPN messages"},{"id":"d7640cc9.18deb","type":"tab","label":"Decode to observations"},{"id":"52ba9841.7af4c8","type":"tab","label":"Log observations"},{"id":"be490f86.19595","type":"tab","label":"Process observations"},{"id":"2acfce56.22a7b2","type":"tab","label":"Process alerts"},{"id":"6e2fec04.b5dce4","type":"tab","label":"TTN test messages"},{"id":"ed3b0860.c759b8","type":"mqtt-broker","z":"","broker":"staging.thethingsnetwork.org","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":""},{"id":"cbe500ee.718ca","type":"MySQLdatabase","z":"","host":"mysql","port":"3306","db":"showcase","tz":""},{"id":"b3c7fccb.6d8ba","type":"telegram bot","z":"","botname":"sparky","usernames":"[]","chatids":"[]"},{"id":"62d11e19.37f06","type":"amqp-server","z":"","host":"rabbitmq","port":"5672","vhost":"","keepalive":"30","usetls":false,"verifyservercert":true,"usetopology":false,"topology":"{\n\t\"exchanges\": [\n\t\t{\"name\": \"showcase.ttn_message\", \"type\": \"fanout\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.observation\", \"type\": \"fanout\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.logged_observation\", \"type\": \"fanout\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.alert\", \"type\": \"fanout\", \"options\": {\"durable\": true}}\t\t\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"showcase.ttn_message.decode\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.observation.log\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.heartbeat.process\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.logged_observation.process\", \"options\": {\"durable\": true}},\n\t\t{\"name\": \"showcase.alert.process\", \"options\": {\"durable\": true}}\t\t\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"showcase.ttn_message\", \"queue\": \"showcase.ttn_message.decode\"},\n\t\t{\"source\": \"showcase.observation\", \"queue\": \"showcase.observation.log\"},\n\t\t{\"source\": \"showcase.logged_observation\", \"queue\": \"showcase.logged_observation.process\"},\n\t\t{\"source\": \"showcase.alert\", \"queue\": \"showcase.alert.process\"}\t\t\n\t]\n}"},{"id":"c845a32f.27b4a","type":"mysql","z":"52ba9841.7af4c8","mydb":"cbe500ee.718ca","name":"","x":614,"y":37,"wires":[["f812c2f4.fa6b3","2d2ed768.555b38"]]},{"id":"3234b502.94134a","type":"function","z":"52ba9841.7af4c8","name":"log observation in MySQL","func":"var observationTimestamp = msg.payload.timestamp.slice(0, 19).replace('T', ' '); // new Date().toISOString().slice(0, 19).replace('T', ' ')\nvar nodeId = msg.payload.nodeId;\nvar sensorId = msg.payload.sensorId;\nvar sensorValue = msg.payload.sensorValue;\nvar sensorError = msg.payload.sensorError;\n\n// todo: insert sensorError into observation table\nmsg.topic = \n     \"INSERT INTO observatie ( \" +\n         \"datum_tijd_aangemaakt,\" +\n         \"node,\" +\n         \"sensor,\" +\n         \"waarde) \" +\n     \"VALUES (\" +\n        \"'\" + observationTimestamp +\"',\" +\n        \"'\" + nodeId + \"',\" +\n        sensorId + \", \" + \n        \"'\" + sensorValue + \"'\" +\n     \");\";\nmsg.originalPayload = msg.payload;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":401,"y":37,"wires":[["c845a32f.27b4a","5ab80c23.bb2de4"]]},{"id":"3411915c.dce96e","type":"amqp in","z":"d7640cc9.18deb","name":"","topic":"","iotype":"1","ioname":"showcase.ttn_message","server":"62d11e19.37f06","x":128.5,"y":68.14999389648438,"wires":[["dec2638d.07dec","4cfb12d3.f3270c"]]},{"id":"b9aa12db.d2e8a","type":"amqp in","z":"52ba9841.7af4c8","name":"","topic":"","iotype":"1","ioname":"showcase.observation","server":"62d11e19.37f06","x":119.5,"y":37.149993896484375,"wires":[["3234b502.94134a","9f1c1e20.93e1b"]]},{"id":"dec2638d.07dec","type":"debug","z":"d7640cc9.18deb","name":"raw message","active":true,"console":"false","complete":"payload","x":342.5,"y":115.29998779296875,"wires":[]},{"id":"f812c2f4.fa6b3","type":"debug","z":"52ba9841.7af4c8","name":"log observation","active":false,"console":"false","complete":"true","x":799.5,"y":88.29998779296875,"wires":[]},{"id":"dfa94d.578eb6b","type":"function","z":"d7640cc9.18deb","name":"decode to observations","func":"//decode msg.payload.payload with protobuf\n\n// using npm module protocol-buffers (globally installed on server)\n// see: https://www.npmjs.com/package/protocol-buffers\nvar protoBufMsg = context.get(\"protoBufMsg\");\nif (protoBufMsg === undefined) {\n    var fs = global.get(\"fs\");\n    var protoBuf = global.get(\"protoBuf\");\n    protoBufMsg = protoBuf(fs.readFileSync(\"/node-red-data/sensor.proto\"));\n    context.set(\"protoBufMsg\", protoBufMsg);\n}\n\nvar payload = new Buffer(msg.payload.payload, 'base64');\nvar ttnMsg = protoBufMsg.NodeMessage.decode(payload);\n\nvar nodeId = msg.payload.dev_eui;\nvar timestamp = msg.payload.metadata[0].server_time; // todo: bepaal de correcte timestamp\n\n// expect ttnMsg to have a reading property that contains an array of objects\n// each object contains the properties defined in sensor.proto SensorReading\nvar reading = ttnMsg.reading;\n// send all sensor values as separate msg's\nfor (var len = reading.length, i=0; i < len; i++) {\n    node.send({\n        topic: \"sensor observation\",\n        payload: {\n            nodeId: nodeId,\n            sensorId: reading[i].id,\n            sensorValue: reading[i].value1,\n            sensorError: reading[i].error,\n            timestamp: timestamp\n        }\n    });\n}\n\n// check for skipped messages\nvar msgSkippedSensorId = -1;\nvar msgCounters = context.get(\"messageCounters\") || {};\nvar currentCount = msg.payload.counter;\nvar lastCount = msgCounters[nodeId] || currentCount - 1;\nvar skippedCount = currentCount - lastCount - 1;\n// node.warn(\"Message count: \" + currentCount + \" previous count: \" + lastCount + \" skipped: \" + skippedCount);\nif (skippedCount) {\n    node.send({\n        topic: \"sensor observation\",\n        payload: {\n            nodeId: nodeId,\n            sensorId: msgSkippedSensorId,\n            sensorValue: skippedCount,\n            sensorError: 0,\n            timestamp: timestamp\n        }\n    });\n}\nmsgCounters[nodeId] = currentCount;\ncontext.set(\"messageCounters\", msgCounters);\n\n// always notify that node is still alive (in a clean msg)\nreturn {\n        topic: \"sensor observation\",\n        payload: {\n          nodeId: nodeId,\n          sensorId: 0,\n          sensorValue: 1,\n          timestamp: timestamp\n        }\n    };\n\n\n","outputs":1,"noerr":0,"x":515.5,"y":68.449951171875,"wires":[["5b1d268c.b053a8"]]},{"id":"5b1d268c.b053a8","type":"amqp out","z":"d7640cc9.18deb","name":"","routingkey":"","iotype":"1","ioname":"showcase.observation","server":"62d11e19.37f06","x":759.5,"y":68.29995727539062,"wires":[]},{"id":"5ab80c23.bb2de4","type":"debug","z":"52ba9841.7af4c8","name":"","active":false,"console":"false","complete":"true","x":602.5,"y":87.29998779296875,"wires":[]},{"id":"2d2ed768.555b38","type":"function","z":"52ba9841.7af4c8","name":"add observation id","func":"var observationId = msg.payload.insertId;\nvar payload = msg.originalPayload;\npayload.id = observationId;\n\nmsg = {\n    topic: \"logged observation\",\n    payload: payload\n}\nreturn msg;","outputs":1,"noerr":0,"x":808.5,"y":37.43999481201172,"wires":[["3cd3f3c.0ba0b0c","2be57a32.94ff16"]]},{"id":"3cd3f3c.0ba0b0c","type":"amqp out","z":"52ba9841.7af4c8","name":"","routingkey":"","iotype":"1","ioname":"showcase.logged_observation","server":"62d11e19.37f06","x":1074.5,"y":37.29999542236328,"wires":[]},{"id":"2be57a32.94ff16","type":"debug","z":"52ba9841.7af4c8","name":"","active":true,"console":"false","complete":"false","x":1013.5,"y":87.30000305175781,"wires":[]},{"id":"469c457d.abc18c","type":"amqp in","z":"be490f86.19595","name":"","topic":"","iotype":"1","ioname":"showcase.logged_observation","server":"62d11e19.37f06","x":143.5,"y":74.14999389648438,"wires":[["82c9210e.093f4"]]},{"id":"82c9210e.093f4","type":"function","z":"be490f86.19595","name":"haal alarmregels","func":"msg.originalPayload = msg.payload;\nmsg.topic = \"SELECT id, alarm_trigger FROM alarm_regel WHERE \" +\n    \"node = '\" + msg.payload.nodeId + \"'\" +\n    \" AND \" +\n    \"sensor = \" + msg.payload.sensorId + \";\";\nreturn msg;","outputs":1,"noerr":0,"x":386.5,"y":74.44999694824219,"wires":[["801977fa.c23ed8"]]},{"id":"801977fa.c23ed8","type":"mysql","z":"be490f86.19595","mydb":"cbe500ee.718ca","name":"","x":565,"y":74,"wires":[["76a96778.5456b8","bac44cbb.b4b28"]]},{"id":"76a96778.5456b8","type":"function","z":"be490f86.19595","name":"check alarmregels","func":"var safeEval = global.get(\"safeEval\");\n\nvar rules = msg.payload;\nvar observation = msg.originalPayload;\nvar value = observation.sensorValue;\n\nfunction sendAlert(rule) {\n    var alertMsg = {\n        topic: \"rule alert\",\n        payload: {\n            nodeId: observation.nodeId,\n            sensorId: observation.sensorId,\n            sensorValue: observation.sensorValue,\n            observationId: observation.id,\n            ruleId: rule.id\n        }\n    }\n    node.send(alertMsg)    \n}\n\nfunction timeoutAlert(rule) {\n    delete heartbeatTimers[rule.id];\n    sendAlert(rule);\n}\n\nif (observation.sensorId === 0) {\n    // sensor 0 is the heartbeat, setup timeout(s)\n    var heartbeatTimers = context.get(\"heartbeatTimers\") || {};\n    for (var len = rules.length, i = 0; i < len; i++) {\n        // stop running timer\n        var timer = heartbeatTimers[rules[i].id];\n        // reset heartbeat timeout timer\n        if (timer) {\n            clearTimeout(timer);\n        }\n        var timeoutSeconds = Number(rules[i].alarm_trigger);\n        if (!isNaN(timeoutSeconds)) {\n            timer = setTimeout(timeoutAlert, timeoutSeconds * 1000, rules[i]);\n            heartbeatTimers[rules[i].id] = timer;            \n        }\n    }\n    context.set(\"heartbeatTimers\", heartbeatTimers);\n} else if (!observation.sensorError) {\n    // evaluate alarm_trigger(s)\n    for (var len = rules.length, i = 0; i < len; i++) {\n        try {\n            var evalContext = {\n                X: value,\n                x: value\n            };\n            var result = safeEval(rules[i].alarm_trigger, evalContext);\n            // node.warn(\"rule evaluation for rule \" + rules[i].id +\n            //     \" on state '\" + rules[i].alarm_trigger + \"', with x = \" + value + \" returns \" + result);\n            if (result) {\n                sendAlert(rules[i]);\n            }\n        } catch (err) {\n            // todo: log rule evaluation error\n            node.error(\"rule evaluation error for rule \" + rules[i].id +\n                \" on state '\" + rules[i].alarm_trigger + \"', with x = \" + value);\n        }\n    }\n}\n","outputs":1,"noerr":0,"x":759.5,"y":74.44999694824219,"wires":[["f2f4ca99.9581a8","c648babe.a6ad08"]]},{"id":"f2f4ca99.9581a8","type":"amqp out","z":"be490f86.19595","name":"","routingkey":"","iotype":"1","ioname":"showcase.alert","server":"62d11e19.37f06","x":972.5,"y":74.30000305175781,"wires":[]},{"id":"bac44cbb.b4b28","type":"debug","z":"be490f86.19595","name":"","active":false,"console":"false","complete":"payload","x":740.5,"y":124.29998779296875,"wires":[]},{"id":"9509f6a8.7538c8","type":"amqp in","z":"2acfce56.22a7b2","name":"","topic":"","iotype":"1","ioname":"showcase.alert","server":"62d11e19.37f06","x":108.5,"y":146.14999389648438,"wires":[["12efee9.66ad811","136f40a7.3a376f"]]},{"id":"12efee9.66ad811","type":"function","z":"2acfce56.22a7b2","name":"get alert notification actions","func":"// notification table has yet to be implemented\nmsg.topic = \n    \"SELECT kanaal, p1, p2, p3, p4, meldingtekst FROM alarm_notificatie \" +\n    \"WHERE alarm_regel = \" + msg.payload.ruleId + \";\";\nmsg.originalPayload = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":388.5,"y":125.44999694824219,"wires":[["65847d9a.9d1b34"]]},{"id":"136f40a7.3a376f","type":"function","z":"2acfce56.22a7b2","name":"log alert","func":"msg.topic = \n    \"INSERT INTO alarm ( \" +\n        \"alarm_regel,\" +\n        \"observatie) \" +\n    \"VALUES (\" +\n        msg.payload.ruleId + \",\" +\n        msg.payload.observationId + \n    \");\";\nmsg.originalPayload = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":328.5,"y":168.44998168945312,"wires":[["9b7489cf.d3c698","399aa278.659a4e"]]},{"id":"9b7489cf.d3c698","type":"mysql","z":"2acfce56.22a7b2","mydb":"cbe500ee.718ca","name":"","x":484,"y":169,"wires":[[]]},{"id":"65847d9a.9d1b34","type":"mysql","z":"2acfce56.22a7b2","mydb":"cbe500ee.718ca","name":"","x":602,"y":125,"wires":[["9b608ccd.27f3e","54d9245a.d1904c","39201c60.eea254"]]},{"id":"399aa278.659a4e","type":"debug","z":"2acfce56.22a7b2","name":"","active":false,"console":"false","complete":"false","x":491.5,"y":216.29998779296875,"wires":[]},{"id":"9f1c1e20.93e1b","type":"debug","z":"52ba9841.7af4c8","name":"","active":false,"console":"false","complete":"false","x":362.5,"y":84.29998779296875,"wires":[]},{"id":"cb6807a0.d9fd18","type":"Slack Bot Out","z":"2acfce56.22a7b2","name":"sparky (slack)","apiToken":"xoxb-63081672787-taRL39u95elfJ8ARh1gGvRUR","channel":"","x":996,"y":103,"wires":[]},{"id":"545b676c.d7ae28","type":"telegram sender","z":"2acfce56.22a7b2","name":"sparky (telegram)","bot":"b3c7fccb.6d8ba","x":1007,"y":152,"wires":[[]]},{"id":"9b608ccd.27f3e","type":"function","z":"2acfce56.22a7b2","name":"notify to Slack","func":"var notificaties = msg.payload;\nvar alert = msg.originalPayload;\n\nfor (var i=0, len = notificaties.length; i < len; i++) {\n    var notificatie = notificaties[i];\n    \n    if (notificatie.kanaal === \"slack\") {\n        var slackMsg = {\n            payload: notificatie.meldingtekst\n        };\n        if (notificatie.p1) {\n            slackMsg.channel = notificatie.p1;\n        }\n        node.send(slackMsg)\n    }\n}\n\nreturn null;\n","outputs":1,"noerr":0,"x":786,"y":103,"wires":[["cb6807a0.d9fd18"]]},{"id":"54d9245a.d1904c","type":"function","z":"2acfce56.22a7b2","name":"notify to Telegram","func":"var notificaties = msg.payload;\nvar alert = msg.originalPayload;\n\nfor (var i=0, len = notificaties.length; i < len; i++) {\n    var notificatie = notificaties[i];\n    \n    if (notificatie.kanaal === \"telegram\") {\n        node.send({\n            payload: {\n                type: \"message\",\n                content: notificatie.meldingtekst,\n                chatId: notificatie.p1\n            }\n        });\n    }\n}\n\nreturn null;","outputs":1,"noerr":0,"x":797,"y":152,"wires":[["545b676c.d7ae28"]]},{"id":"e77777ba.a5ad88","type":"inject","z":"6e2fec04.b5dce4","name":"raw TTN protobuf alive test msg","topic":"70B3D57ED0000105/devices/000000007FEE6E5B/up","payload":"{\"payload\":\"CgQIARgC\",\"port\":1,\"counter\":8,\"dev_eui\":\"000000007FEE6E5B\",\"metadata\":[{\"frequency\":868.5,\"datarate\":\"SF7BW125\",\"codingrate\":\"4/5\",\"gateway_timestamp\":2913536323,\"channel\":2,\"server_time\":\"2016-09-09T09:14:32.141349077Z\",\"rssi\":-34,\"lsnr\":6.2,\"rfchain\":1,\"crc\":1,\"modulation\":\"LORA\",\"gateway_eui\":\"0000024B0805026F\",\"altitude\":-1,\"longitude\":5.26561,\"latitude\":52.05755}]}","payloadType":"str","repeat":"","crontab":"","once":false,"x":181,"y":89,"wires":[["b3d9ed67.a49e5"]]},{"id":"7a30efb7.d38fe","type":"comment","z":"6e2fec04.b5dce4","name":"Raw base64 test messages","info":"","x":173,"y":40,"wires":[]},{"id":"b3d9ed67.a49e5","type":"amqp out","z":"6e2fec04.b5dce4","name":"","routingkey":"","iotype":"1","ioname":"showcase.ttn_message","server":"62d11e19.37f06","x":506.5,"y":193.29998779296875,"wires":[]},{"id":"c648babe.a6ad08","type":"debug","z":"be490f86.19595","name":"","active":false,"console":"false","complete":"false","x":963.5,"y":122.29998779296875,"wires":[]},{"id":"5bc3fb95.080b34","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): 23","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":0,\"sensorValue\":\"23\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":865,"y":86,"wires":[["1ae86ba7.6f57f4"]]},{"id":"1ae86ba7.6f57f4","type":"amqp out","z":"6e2fec04.b5dce4","name":"","routingkey":"","iotype":"1","ioname":"showcase.observation","server":"62d11e19.37f06","x":1232,"y":169,"wires":[]},{"id":"23d0f6b5.b2337a","type":"comment","z":"6e2fec04.b5dce4","name":"Decoded test observations","info":"","x":788,"y":38,"wires":[]},{"id":"df0afc4f.9af58","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 0 (heartbeat)","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":0,\"sensorError\":0,\"sensorValue\":\"0\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":875,"y":302,"wires":[["1ae86ba7.6f57f4"]]},{"id":"39201c60.eea254","type":"debug","z":"2acfce56.22a7b2","name":"","active":false,"console":"false","complete":"false","x":779,"y":201,"wires":[]},{"id":"ba729509.017e78","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): 2","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":0,\"sensorValue\":\"2\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":865,"y":133,"wires":[["1ae86ba7.6f57f4"]]},{"id":"13c7dae3.efce65","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): 80","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":0,\"sensorValue\":\"80\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":866,"y":179,"wires":[["1ae86ba7.6f57f4"]]},{"id":"dd0d7899.e5c0d8","type":"inject","z":"6e2fec04.b5dce4","name":"test node 00000000D1EC2A39 sensor 2 (temp): error","topic":"sensor observation","payload":"{\"timestamp\":\"2016-08-02T09:26:56.369421Z\",\"nodeId\":\"00000000D1EC2A39\",\"sensorId\":2,\"sensorError\":1,\"sensorValue\":null}","payloadType":"json","repeat":"","crontab":"","once":false,"x":876,"y":228,"wires":[["1ae86ba7.6f57f4"]]},{"id":"4cfb12d3.f3270c","type":"json","z":"d7640cc9.18deb","name":"","x":320.5,"y":68.44999694824219,"wires":[["dfa94d.578eb6b"]]},{"id":"842e249a.6df468","type":"mqtt in","z":"97f270ed.0e384","name":"TTN exchange receiver","topic":"#","qos":"1","broker":"ed3b0860.c759b8","x":117,"y":85,"wires":[["61931666.dd1188","e82049c8.da6688"]]},{"id":"61931666.dd1188","type":"debug","z":"97f270ed.0e384","name":"","active":false,"console":"false","complete":"true","x":364,"y":161,"wires":[]},{"id":"e82049c8.da6688","type":"amqp out","z":"97f270ed.0e384","name":"","routingkey":"","iotype":"1","ioname":"showcase.ttn_message","server":"62d11e19.37f06","x":416,"y":85,"wires":[]},{"id":"59865aeb.5d6e14","type":"amqp in","z":"95a66cfb.0120b","name":"","topic":"","iotype":"4","ioname":"showcase.kpn_message","server":"62d11e19.37f06","x":137.5,"y":177,"wires":[["be91bc22.9e2d6","c3f4f2e5.2d9ca","ebde13aa.0cd35"]]},{"id":"a5d8ae84.03af6","type":"amqp out","z":"95a66cfb.0120b","name":"","routingkey":"","iotype":"1","ioname":"showcase.ttn_message","server":"62d11e19.37f06","x":985,"y":176,"wires":[]},{"id":"95d3a829.a9f1e8","type":"function","z":"95a66cfb.0120b","name":"test payload","func":"// using npm module protocol-buffers (globally installed on server)\n// see: https://www.npmjs.com/package/protocol-buffers\nvar protoBufMsg = context.get(\"protoBufMsg\");\nif (protoBufMsg === undefined) {\n    var fs = global.get(\"fs\");\n    var protoBuf = global.get(\"protoBuf\");\n    protoBufMsg = protoBuf(fs.readFileSync(\"/node-red-data/sensor.proto\"));\n    context.set(\"protoBufMsg\", protoBufMsg);\n}\n//var payload = new Buffer(msg.payload.payload, 'base64');\n//var ttnMsg = protoBufMsg.NodeMessage.decode(payload);\n\nfunction decodeProtobuf (msg) {\n  // debug code to examine protobuf content\n  var rawPayload = msg.payload_hex;\n  node.warn(\"raw payload: \" + rawPayload);\n  var payload = new Buffer(msg.payload_hex, 'hex');\n  var decodedPayload = protoBufMsg.NodeMessage.decode(payload);\n  node.warn(\"decoded payload: \" + JSON.stringify(decodedPayload));\n  \n}\n\ndecodeProtobuf(msg.payload);\n\nreturn null;","outputs":1,"noerr":0,"x":466.5,"y":370.45001220703125,"wires":[[]]},{"id":"ebde13aa.0cd35","type":"function","z":"95a66cfb.0120b","name":"convert KPN to TTN message","func":"// KPN Lora JSON format:\n// {\n//     \"LrrSNR\": \"0\",\n//     \"Lrrid\": null,\n//     \"SpFact\": 0,\n//     \"SubBand\": null,\n//     \"CustomerData\": null,\n//     \"FPort\": 1,\n//     \"Channel\": null,\n//     \"FCntUp\": -1,\n//     \"Time\": null,\n//     \"DevEUI\": \"0059AC000018041B\",\n//     \"payload_hex\": \"CgQIBxgC\",\n//     \"CustomerID\": 0,\n//     \"LrrRSSI\": \"0\",\n//     \"ADRbit\": 0,\n//     \"ModelCfg\": 0,\n//     \"mic_hex\": null,\n//     \"LrrLON\": \"0\",\n//     \"LrrLAT\": \"0\",\n//     \"FCntDn\": 0,\n//     \"Lrcid\": null,\n//     \"DevLrrCnt\": 0\n// }\n\n// TTN Lora JSON format:\n// {\n//     \"payload\": \"CgQIARgC\",\n//     \"port\": 1,\n//     \"counter\": 8,\n//     \"dev_eui\": \"000000007FEE6E5B\",\n//     \"metadata\": [\n//         {\n//             \"frequency\": 868.5,\n//             \"datarate\": \"SF7BW125\",\n//             \"codingrate\": \"4/5\",\n//             \"gateway_timestamp\": 2913536323,\n//             \"channel\": 2,\n//             \"server_time\": \"2016-09-09T09:14:32.141349077Z\",\n//             \"rssi\": -34,\n//             \"lsnr\": 6.2,\n//             \"rfchain\": 1,\n//             \"crc\": 1,\n//             \"modulation\": \"LORA\",\n//             \"gateway_eui\": \"0000024B0805026F\",\n//             \"altitude\": -1,\n//             \"longitude\": 5.26561,\n//             \"latitude\": 52.05755\n//         }\n//     ]\n// }\n\nfunction convertToTTN(payload) {\n  var KPNMsg = payload;\n  var TTNMsg = {\n    payload: new Buffer(KPNMsg.payload_hex, \"hex\").toString(\"base64\"),\n    port: KPNMsg.FPort,\n    counter: 0, // todo: determine counter for KPN lora msg, if not available: redesign counter code\n    dev_eui: KPNMsg.DevEUI,\n    metadata: [\n        {\n          server_time: new Date().toISOString(),\n          longitude: KPNMsg.LrrLON,      \n          lattitude: KPNMsg.LrrLAT\n          // other metadata fields ignored for now\n        }\n    ]\n  }\n  return TTNMsg;\n}\n\nmsg.payload = convertToTTN(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":574.5,"y":176.45001220703125,"wires":[["d6e6a25b.741b5"]]},{"id":"d6e6a25b.741b5","type":"json","z":"95a66cfb.0120b","name":"","x":786.5,"y":176.45001220703125,"wires":[["a5d8ae84.03af6"]]},{"id":"13819.cad867e73","type":"inject","z":"95a66cfb.0120b","name":"KPN Sodaq One 0006 (long msg)","topic":"","payload":"{ \"LrrSNR\": \"-8.500000\", \"Lrrid\": \"FF010174\", \"SpFact\": 7, \"SubBand\": \"G0\", \"CustomerData\": \"{\\\"alr\\\":{\\\"pro\\\":\\\"SMTC/LoRaMote\\\",\\\"ver\\\":\\\"1\\\"}}\", \"FPort\": 1, \"Channel\": \"LC1\", \"FCntUp\": 5, \"Time\": 1475066390517, \"DevEUI\": \"0059AC000018041B\", \"payload_hex\": \"0a04080218130a04080318010a04080410010a04080510010a0408061001\", \"CustomerID\": 100006356, \"LrrRSSI\": \"-127.000000\", \"ADRbit\": 0, \"ModelCfg\": 0, \"mic_hex\": \"5c4d5c0f\", \"LrrLON\": \"5.229730\", \"LrrLAT\": \"52.048149\", \"FCntDn\": 14, \"Lrcid\": \"0059AC01\", \"DevLrrCnt\": 1, \"payload\": \"0a04080218130a04080318010a04080410010a04080510010a0408061001\", \"dev_eui\": \"0059AC000018041B\", \"counter\": 0, \"server_time\": \"2016-09-28T12:39:51.017Z\" }","payloadType":"json","repeat":"","crontab":"","once":false,"x":175.5,"y":370,"wires":[["ebde13aa.0cd35"]]},{"id":"be91bc22.9e2d6","type":"debug","z":"95a66cfb.0120b","name":"","active":true,"console":"false","complete":"payload","x":370.5,"y":230,"wires":[]},{"id":"f63ba175.32443","type":"inject","z":"95a66cfb.0120b","name":"KPN Sodaq One 0006 (0=1,1=0)","topic":"","payload":"{ \"LrrSNR\": \"-7.500000\", \"Lrrid\": \"080E035E\", \"SpFact\": 7, \"SubBand\": \"G0\", \"CustomerData\": \"{\\\"alr\\\":{\\\"pro\\\":\\\"SMTC/LoRaMote\\\",\\\"ver\\\":\\\"1\\\"}}\", \"FPort\": 1, \"Channel\": \"LC2\", \"FCntUp\": 2, \"Time\": 1475501410829, \"DevEUI\": \"0059AC000018041B\", \"payload_hex\": \"0a0408011800\", \"CustomerID\": 100006356, \"LrrRSSI\": \"-119.000000\", \"ADRbit\": 0, \"ModelCfg\": 0, \"mic_hex\": \"f402dfd2\", \"LrrLON\": \"5.304723\", \"LrrLAT\": \"52.085842\", \"FCntDn\": 6, \"Lrcid\": \"0059AC01\", \"DevLrrCnt\": 1, \"query\": { \"LrnDevEui\": \"0059AC000018041B\", \"LrnFPort\": \"1\", \"LrnInfos\": \"null\", \"AS_ID\": \"Politie.developer\", \"Time\": \"2016-10-03T13:30:11.155Z\", \"Token\": \"4fdc65a53d5057aee8f9a17cfd66e3a18106d5926131974b5e9d3501d97d11e0\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":176.5,"y":332,"wires":[["ebde13aa.0cd35"]]},{"id":"838eea8a.1c0558","type":"inject","z":"95a66cfb.0120b","name":"KPN Sodaq One 0006 (0=1,1=1)","topic":"","payload":"{ \"LrrSNR\": \"-7.500000\", \"Lrrid\": \"080E035E\", \"SpFact\": 7, \"SubBand\": \"G0\", \"CustomerData\": \"{\\\"alr\\\":{\\\"pro\\\":\\\"SMTC/LoRaMote\\\",\\\"ver\\\":\\\"1\\\"}}\", \"FPort\": 1, \"Channel\": \"LC2\", \"FCntUp\": 2, \"Time\": 1475501410829, \"DevEUI\": \"0059AC000018041B\", \"payload_hex\": \"0a0408011802\", \"CustomerID\": 100006356, \"LrrRSSI\": \"-119.000000\", \"ADRbit\": 0, \"ModelCfg\": 0, \"mic_hex\": \"f402dfd2\", \"LrrLON\": \"5.304723\", \"LrrLAT\": \"52.085842\", \"FCntDn\": 6, \"Lrcid\": \"0059AC01\", \"DevLrrCnt\": 1, \"query\": { \"LrnDevEui\": \"0059AC000018041B\", \"LrnFPort\": \"1\", \"LrnInfos\": \"null\", \"AS_ID\": \"Politie.developer\", \"Time\": \"2016-10-03T13:30:11.155Z\", \"Token\": \"4fdc65a53d5057aee8f9a17cfd66e3a18106d5926131974b5e9d3501d97d11e0\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":175.5,"y":292,"wires":[["ebde13aa.0cd35"]]},{"id":"c3f4f2e5.2d9ca","type":"file","z":"95a66cfb.0120b","name":"","filename":"/node-red-data/KPNtracker.txt","appendNewline":true,"createDir":false,"overwriteFile":"false","x":537,"y":286,"wires":[]},{"id":"4827676f.04ad98","type":"inject","z":"95a66cfb.0120b","name":"KPN Test Query via Mendix","topic":"","payload":"{ \"LrrSNR\": \"0\", \"Lrrid\": null, \"SpFact\": 0, \"SubBand\": null, \"CustomerData\": null, \"FPort\": 1, \"Channel\": null, \"FCntUp\": -1, \"Time\": null, \"DevEUI\": \"0059AC000018041B\", \"payload_hex\": \"0a0408011802\", \"CustomerID\": 0, \"LrrRSSI\": \"0\", \"ADRbit\": 0, \"ModelCfg\": 0, \"mic_hex\": null, \"LrrLON\": \"0\", \"LrrLAT\": \"0\", \"FCntDn\": 0, \"Lrcid\": null, \"DevLrrCnt\": 0, \"query\": { \"LrnDevEui\": \"0059AC000018041B\", \"LrnFPort\": \"1\", \"LrnInfos\": \"null\", \"AS_ID\": \"Politie.developer\", \"Time\": \"2016-10-03T13:58:53.655 02:00\", \"Token\": \"c4159f84e6eb0c6316ecdd53f68d412cf84d8aacebded180c804aa84a66a0e4d\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":164.5,"y":414,"wires":[["ebde13aa.0cd35"]]}]