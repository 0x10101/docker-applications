[{"id":"97f270ed.0e384","type":"tab","label":"Process TTN messages"},{"id":"2acfce56.22a7b2","type":"tab","label":"Send notification"},{"id":"4c9ff67a.a5b8c8","type":"tab","label":"TTN test messages"},{"id":"ed3b0860.c759b8","type":"mqtt-broker","z":"","broker":"staging.thethingsnetwork.org","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":""},{"id":"cbe500ee.718ca","type":"MySQLdatabase","z":"","host":"172.25.0.8","port":"3306","db":"showcase","tz":""},{"id":"1185a379.d097bd","type":"mqtt-broker","z":"","broker":"rabbitmq","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"b3c7fccb.6d8ba","type":"telegram bot","z":"","botname":"sparky","usernames":"[]","chatids":"[]"},{"id":"62d11e19.37f06","type":"amqp-server","z":"","host":"rabbitmq","port":"5672","vhost":"","keepalive":"30","usetls":false,"verifyservercert":true,"usetopology":false,"topology":"{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}"},{"id":"842e249a.6df468","type":"mqtt in","z":"97f270ed.0e384","name":"TTN exchange receiver","topic":"#","qos":"1","broker":"ed3b0860.c759b8","x":109,"y":307,"wires":[["123cc53d.31fb9b","61931666.dd1188"]]},{"id":"123cc53d.31fb9b","type":"json","z":"97f270ed.0e384","name":"","x":305,"y":292,"wires":[["33463682.88a03a","8da51734.d9e7e8","e82049c8.da6688"]]},{"id":"61931666.dd1188","type":"debug","z":"97f270ed.0e384","name":"","active":false,"console":"false","complete":"true","x":305,"y":332,"wires":[]},{"id":"3cb95449.ccf2fc","type":"mysql","z":"97f270ed.0e384","mydb":"cbe500ee.718ca","name":"","x":1068,"y":27,"wires":[[]]},{"id":"6c633151.4557b","type":"function","z":"97f270ed.0e384","name":"Log heartbeat in MySQL","func":"var temp = msg.payload.fields.temp;\nmsg.topic = \n     \"INSERT INTO event ( \" +\n     \"version,\" +\n     \"date_created,\" +\n     \"event_type_id,\" +\n     \"sensor_id,\" +\n     \"class,\" + \n     \"status,\" +\n     \"temperature) \" +\n     \"SELECT \" +\n        \"1,\" +\n        \"'\"+new Date().toISOString().slice(0, 19).replace('T', ' ')+\"',\" +\n        \"2,\" +\n        \"id, \" + \n        \"'showcase.event.TemperatureEvent',\" +\n        \"NULL,\" +\n        (temp !== \"ER\" ? temp : \"NULL\") + \" \" + \n      \"FROM sensor WHERE identifier LIKE '\" + msg.payload.dev_eui + \"';\";\nmsg.heartbeatPayload = msg.payload;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":824,"y":27,"wires":[["3cb95449.ccf2fc"]]},{"id":"e82049c8.da6688","type":"amqp out","z":"97f270ed.0e384","name":"ruwe stroom RabbitMQ","routingkey":"","iotype":"1","ioname":"showcase.raw","server":"62d11e19.37f06","x":520,"y":231,"wires":[]},{"id":"33463682.88a03a","type":"function","z":"97f270ed.0e384","name":"n2s_converter","func":"// { \"gatewayEui\": \"0000024B0805026F\", \"nodeEui\": \"02015E01\", \"time\": \"2016-02-18T09:58:49.075896468Z\", \"frequency\": 868.5, \"dataRate\": \"SF7BW125\", \n// \"rssi\": -30, \"snr\": 6.5, \"rawData\": \"QAFeAQIAmyIBImZILKIpUOq5l37/UUg=\", \"data\": \"CgAUVXiVKQAQIw==\" }\n\nmsg2 = {};\nmsg2.payload = {};\nmsg2.payload.dev_id = msg.payload.dev_eui.substring(8,16);\nmsg2.payload.counter = msg.payload.counter;\nmsg2.payload.datatxt = new Buffer(msg.payload.payload, 'base64').toString();\nmsg2.payload.datahex = new Buffer(msg.payload.payload, 'base64').toString('hex');\n\nreturn msg2;","outputs":"1","noerr":0,"x":491,"y":398,"wires":[["adff483d.157558","3cb3b29e.73ce8e"]]},{"id":"adff483d.157558","type":"debug","z":"97f270ed.0e384","name":"","active":false,"console":"false","complete":"false","x":686,"y":397,"wires":[]},{"id":"3cb3b29e.73ce8e","type":"file","z":"97f270ed.0e384","name":"","filename":"ttn_logging","appendNewline":true,"createDir":true,"overwriteFile":"false","x":686,"y":437,"wires":[]},{"id":"f56d31d5.4c1d3","type":"amqp out","z":"97f270ed.0e384","name":"keepalive RabbitMQ","routingkey":"","iotype":"1","ioname":"showcase.keepalive","server":"62d11e19.37f06","x":812,"y":227,"wires":[]},{"id":"8da51734.d9e7e8","type":"function","z":"97f270ed.0e384","name":"Decode and split payload","func":"var payload = new Buffer(msg.payload.payload, 'base64').toString();\nmsg.payload.payload = payload;\n\n// decode msg payload string to fields\nif (msg.payload.payload.startsWith(\"Alive\")) {\n    msg.payload.fields = {\n        msgType: \"Alive\",\n        node_id: payload.substring(5,6),\n        temp: payload.substring(7,12),\n        hum: payload.substring(13,18),\n        volt: payload.substring(19,24)\n    }\n    return [msg, null];\n} else if (msg.payload.payload.startsWith('Sensor')) {\n    var isOpen = payload.substring(8,9) === '1';\n    msg.payload.fields = {\n        msgType: \"Sensor\",\n        isOpen: isOpen,\n        alarm: \"deksel \" + (isOpen ? \"open\" : \"dicht\")\n    }\n    return [null, msg];\n}\n","outputs":"2","noerr":0,"x":519,"y":292,"wires":[["6c633151.4557b","f56d31d5.4c1d3","59c4f930.245228","9d1d9208.a3653","e288718f.1263","6b348b46.902854"],["826ad289.02edd"]]},{"id":"f516bbe9.380d78","type":"function","z":"97f270ed.0e384","name":"timeout alarm","func":"var dev_eui = msg.requestPayload.dev_eui;\nvar keepAliveTimeout = msg.payload[0].keepalivetimeout;\nvar heartbeatTimers = context.get(\"heartbeatTimers\");\nif(heartbeatTimers === undefined) {\n    heartbeatTimers = {};\n}\nvar timer = heartbeatTimers[dev_eui];\n//node.warn(\"Exisiting timer for \" + dev_eui + \": \" + timer);\n\n// reset heartbeat timeout timer\nif (timer) {\n    clearTimeout(timer);\n}\n\n// start new timeout timer\nheartbeatTimers[dev_eui] = setTimeout(function() {\n    // timeout has expired, send warning\n    delete heartbeatTimers[dev_eui];\n    var timeoutMsg = {\n        topic: \"timeout\",\n        payload: {\n            fields: {\n                alarm: \"No heartbeat received during \" + keepAliveTimeout + \" seconds, check if the device is still alive!\",\n                timeout: keepAliveTimeout\n            },\n            dev_eui: dev_eui\n        }\n    };\n    node.send(timeoutMsg);\n}, keepAliveTimeout * 1000); // timeout in ms\n\ncontext.set(\"heartbeatTimers\", heartbeatTimers);\n\nreturn null;","outputs":1,"noerr":0,"x":1193,"y":243,"wires":[["6c76c1de.a9c9b"]]},{"id":"826ad289.02edd","type":"function","z":"97f270ed.0e384","name":"Sensor open alarm","func":"// we don't need to do anything here\nreturn msg;","outputs":1,"noerr":0,"x":797,"y":340,"wires":[["839ecaad.995e98"]]},{"id":"9d1d9208.a3653","type":"function","z":"97f270ed.0e384","name":"Log heartbeat temp in domoticz","func":"var fields = msg.payload.fields;\nvar domoticzMsg = {};\n\nif (fields.temp === \"ER\") {\n  // Temperature error\n  return null;\n} else {\n    // voor Domoticz\n    domoticzMsg.payload = {\n        idx: 19,\n        svalue: fields.temp,\n        node_id: fields.node_id\n    };\n    return domoticzMsg;\n}\n","outputs":1,"noerr":0,"x":844,"y":77,"wires":[["c3173051.f0926"]]},{"id":"59c4f930.245228","type":"function","z":"97f270ed.0e384","name":"Log heartbeat volt in domoticz","func":"var fields = msg.payload.fields;\nvar domoticzMsg = {};\n\nif (fields.temp === \"ER\") {\n  // Temperature error\n  return null;\n} else {\n    // voor Domoticz\n    domoticzMsg.payload = {\n        idx: 20,\n        svalue: fields.volt,\n        node_id: fields.node_id\n    };\n    return domoticzMsg;\n}\n","outputs":1,"noerr":0,"x":842,"y":127,"wires":[["d00e71a0.53c1d"]]},{"id":"c3173051.f0926","type":"mqtt out","z":"97f270ed.0e384","name":"domoticz/in (prowl)","topic":"domoticz/in","qos":"","retain":"","broker":"1185a379.d097bd","x":1096,"y":77,"wires":[]},{"id":"d00e71a0.53c1d","type":"mqtt out","z":"97f270ed.0e384","name":"domoticz/in (prowl)","topic":"domoticz/in","qos":"","retain":"","broker":"1185a379.d097bd","x":1098,"y":127,"wires":[]},{"id":"e288718f.1263","type":"function","z":"97f270ed.0e384","name":"Heartbeat alarm lookup","func":"// needs the following fields:\n//      msg.payload.fields.alarm: alarm message to display\n//      msg.payload.dev_eui: device id\n\nmsg.topic = \"SELECT identifier AS devid, keepalivetimeout, mintemp, maxtemp, minvolt, maxvolt, minhumidity, maxhumidity FROM sensor where identifier = '\"+ msg.payload.dev_eui + \"'\";\nmsg.requestPayload = msg.payload;\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":817.5,"y":285.4499816894531,"wires":[["625eba32.dc0704"]]},{"id":"625eba32.dc0704","type":"mysql","z":"97f270ed.0e384","mydb":"cbe500ee.718ca","name":"","x":1018,"y":285,"wires":[["c0a58787.45fd68","32752acb.23e096","f516bbe9.380d78","6eea46fd.befa"]]},{"id":"c0a58787.45fd68","type":"function","z":"97f270ed.0e384","name":"temperature alarm","func":"if (msg.requestPayload.fields.temp === \"ERR\" || msg.requestPayload.fields.temp === \"\") {\n    return null;\n}\n\nvar dev_eui = msg.requestPayload.dev_eui;\nvar minTemp = Number(msg.payload[0].mintemp);\nvar maxTemp = Number(msg.payload[0].maxtemp);\nvar currentTemp = Number(msg.requestPayload.fields.temp);\n\n//node.warn(\"compare temp: currentTemp: \" + currentTemp + \", minTemp: \" + minTemp + \", maxTemp: \" + maxTemp);\n\ntry {\nif (currentTemp < minTemp || currentTemp > maxTemp) {\n    return {\n        topic: \"temperature\",\n        payload: {\n            fields: {\n                alarm: \"Temperatuur buiten range, huidige temperatuur: \" + currentTemp + \"C (range: \" + minTemp + \"C - \" + maxTemp + \"C)\",\n                temp: currentTemp\n            },\n            dev_eui: dev_eui\n        }\n    };    \n} else {\n    return null;\n}\n} catch (error) {\n    // ignore non-existing or illegal temperature field errors\n    return null;\n}\n","outputs":1,"noerr":0,"x":1202.5,"y":283.45001220703125,"wires":[["6c76c1de.a9c9b"]]},{"id":"32752acb.23e096","type":"function","z":"97f270ed.0e384","name":"voltage alarm","func":"if (msg.requestPayload.fields.volt === \"ERR\" || msg.requestPayload.fields.volt === \"\") {\n    return null;\n}\n\nvar dev_eui = msg.requestPayload.dev_eui;\nvar minVolt = Number(msg.payload[0].minvolt);\nvar maxVolt = Number(msg.payload[0].maxvolt);\nvar currentVolt = Number(msg.requestPayload.fields.volt);\n\ntry {\n    if (currentVolt < minVolt || currentVolt > maxVolt) {\n        return {\n            topic: \"volt\",\n            payload: {\n                fields: {\n                    alarm: \"Voltage buiten range, huidige voltage: \" + currentVolt + \"V (range: \" + minVolt + \"V - \" + maxVolt + \"V)\",\n                    volt: currentVolt\n                },\n                dev_eui: dev_eui\n            }\n        };    \n    } else {\n        return null;\n    }\n} catch (error) {\n    // ignore non-existing or illegal voltage field errors\n    return null;\n}","outputs":1,"noerr":0,"x":1194.5,"y":324.45001220703125,"wires":[["6c76c1de.a9c9b"]]},{"id":"6c76c1de.a9c9b","type":"link out","z":"97f270ed.0e384","name":"","links":["16eb035d.16c15d","894aa939.da0a38"],"x":1357.5,"y":283.29998779296875,"wires":[]},{"id":"839ecaad.995e98","type":"link out","z":"97f270ed.0e384","name":"Send notification","links":["16eb035d.16c15d","894aa939.da0a38"],"x":927.5,"y":340.29998779296875,"wires":[]},{"id":"22a9796.5960886","type":"function","z":"2acfce56.22a7b2","name":"Alarm notification","func":"// needs the following fields:\n//      msg.payload.fields.alarm: alarm message to display\n//      msg.payload.dev_eui: device id\n\nmsg.topic = \"SELECT identifier AS devid, slackchannel, telegramchannel FROM sensor where identifier = '\"+ msg.payload.dev_eui + \"'\";\nmsg.alarmPayload = msg.payload;\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":319,"y":114,"wires":[["a8733663.0f8c98"]]},{"id":"a8733663.0f8c98","type":"mysql","z":"2acfce56.22a7b2","mydb":"cbe500ee.718ca","name":"","x":509,"y":114,"wires":[["2d36b871.4682c8","c2cab950.b13a98","dfeb43e0.4fe75","cad105bc.57f5a8"]]},{"id":"7ab1a17b.9c371","type":"mqtt out","z":"2acfce56.22a7b2","name":"domoticz/in (prowl)","topic":"domoticz/in","qos":"","retain":"","broker":"1185a379.d097bd","x":884,"y":46,"wires":[]},{"id":"a50c08d5.fb3e08","type":"Slack Bot Out","z":"2acfce56.22a7b2","name":"sparky (slack)","apiToken":"xoxb-63081672787-taRL39u95elfJ8ARh1gGvRUR","channel":"","x":874,"y":96,"wires":[]},{"id":"b640fc90.d8a1a","type":"telegram sender","z":"2acfce56.22a7b2","name":"sparky (telegram)","bot":"b3c7fccb.6d8ba","x":901,"y":145,"wires":[[]]},{"id":"2d36b871.4682c8","type":"function","z":"2acfce56.22a7b2","name":"Alarm: Prowl","func":"// tijdelijke code voor prowl, moet zsm verwijderd worden!! Ab\n\nmsg_out = {};\nmsg_out.payload = {};\nmsg_out.payload.dev_eui = msg.alarmPayload.dev_eui;\n\nif (msg.alarmPayload.dev_eui === '0000000029B1A8A0') {\n    msg_out.payload.idx = 6; // Domoticz id\n    msg_out.payload.nvalue = msg.alarmPayload.fields.isOpen;\n    msg_out.payload.svalue = \"\"; //msg.alarmPayload.payload.substring(10,12);\n}\nelse if (msg.alarmPayload.dev_eui === '000000009AA74038') {\n    msg_out.payload.idx = 5; // Domoticz id\n    msg_out.payload.nvalue = msg.alarmPayload.fields.isOpen;\n    msg_out.payload.svalue = \"\"; //msg.alarmPayload.payload.substring(10,12);\n}\n\nreturn msg_out;","outputs":1,"noerr":0,"x":684,"y":46,"wires":[["7ab1a17b.9c371"]]},{"id":"c2cab950.b13a98","type":"function","z":"2acfce56.22a7b2","name":"Alarm: Slack","func":"if(msg.payload[0].slackchannel) {\n  msg.channel = msg.payload[0].slackchannel\n  if(msg.alarmPayload) {\n    msg.payload = \"Alarm: \" + msg.alarmPayload.fields.alarm;\n  } else { \n     msg.payload = \"Alarm\"; \n  }\n  return msg;\n} else { \n  return null;\n}\n","outputs":1,"noerr":0,"x":684,"y":96,"wires":[[]]},{"id":"dfeb43e0.4fe75","type":"function","z":"2acfce56.22a7b2","name":"Alarm: Telegram","func":"msg.alarmPayload\nif(msg.payload[0].telegramchannel) {\n  msg.payload.type = 'message';\n  msg.payload.chatId = msg.payload[0].telegramchannel;\n  if(msg.alarmPayload) {\n    msg.payload.content = \"Alarm: \" + msg.alarmPayload.fields.alarm;\n  } else { \n     msg.payload.content = \"Alarm\"; \n  }\n  return msg;\n} else { \n  return null;\n}\n","outputs":1,"noerr":0,"x":695,"y":145,"wires":[[]]},{"id":"b81ae129.609fb","type":"function","z":"2acfce56.22a7b2","name":"Alarm log in MySQL","func":"msg.topic = \n \"INSERT INTO event ( \" +\n \"version,\" +\n \"date_created,\" +\n \"event_type_id,\" +\n \"sensor_id,\" +\n \"class,\" + \n \"status,\" +\n \"temperature,\" +\n \"voltage) \" +\n \"SELECT \" +\n    \"1,\" +\n    \"'\"+new Date().toISOString().slice(0, 19).replace('T', ' ')+\"',\" +\n    \"1,\" +\n    \"id, \" + \n    \"'showcase.event.\" + (  msg.payload.fields.isOpen !== undefined ? \"Switch\" :\n                            msg.payload.fields.timeout !== undefined ? \"Timeout\" :\n                            msg.payload.fields.temp !== undefined ? \"Temperature\" :\n                            msg.payload.fields.volt !== undefined ? \"Voltage\" : \"Unknown\"\n                         ) + \"Event',\" +\n    (msg.payload.fields.isOpen === undefined ? \"NULL\" : (msg.payload.fields.isOpen ? \"'OPEN'\" : \"'CLOSED'\")) + \",\" +\n    (msg.payload.fields.temp === undefined || msg.payload.fields.temp === \"\" ? \"NULL\" : msg.payload.fields.temp) + \",\" +\n    (msg.payload.fields.volt === undefined || msg.payload.fields.volt === \"\" ? \"NULL\" : msg.payload.fields.volt) + \" \" +\n  \"FROM sensor WHERE identifier LIKE '\"+ msg.payload.dev_eui +\"';\";\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":171,"wires":[["e8b34fc4.d8a1d","40ad428d.77979c"]]},{"id":"e8b34fc4.d8a1d","type":"mysql","z":"2acfce56.22a7b2","mydb":"cbe500ee.718ca","name":"","x":510,"y":171,"wires":[["97c9d176.caffb"]]},{"id":"cad105bc.57f5a8","type":"amqp out","z":"2acfce56.22a7b2","name":"alarm RabbitMQ","routingkey":"","iotype":"1","ioname":"showcase.alarm","server":"62d11e19.37f06","x":694,"y":193,"wires":[]},{"id":"894aa939.da0a38","type":"link in","z":"2acfce56.22a7b2","name":"Send notification","links":["6c76c1de.a9c9b","839ecaad.995e98"],"x":137.5,"y":141.1500244140625,"wires":[["22a9796.5960886","b81ae129.609fb","9484d3c8.cbf12"]]},{"id":"27ad23b4.b5636c","type":"link in","z":"97f270ed.0e384","name":"TTN test msg","links":["4c559d18.7cb7e4","c1670e4.4955cf","a8759405.f56e08","f0bff498.89d618"],"x":193.5,"y":264.1499938964844,"wires":[["123cc53d.31fb9b"]]},{"id":"ef27c5c9.ff2008","type":"inject","z":"4c9ff67a.a5b8c8","name":"TTN test koffer 1 dicht","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"U2Vuc29yMTswOwKE\", \"port\": 1, \"counter\": 3, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.1, \"datarate\": \"SF11BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 4098352996, \"gateway_time\": \"2016-08-03T10:44:24.225385Z\", \"channel\": 0, \"server_time\": \"2016-08-03T10:44:25.07906191Z\", \"rssi\": -51, \"lsnr\": 11.5, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ] }","payloadType":"str","repeat":"","crontab":"","once":false,"x":170,"y":211,"wires":[["c1670e4.4955cf"]]},{"id":"60fdef72.27435","type":"inject","z":"4c9ff67a.a5b8c8","name":"TTN test keepalive ERR msg","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"QWxpdmUyO0VS\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"0000000029B1A8A0\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ] }","payloadType":"str","repeat":"","crontab":"","once":false,"x":189,"y":130,"wires":[["c1670e4.4955cf"]]},{"id":"caa7e8d7.7e9148","type":"inject","z":"4c9ff67a.a5b8c8","name":"TTN test koffer 2 open","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"U2Vuc29yMjsx\", \"port\": 1, \"counter\": 116, \"dev_eui\": \"0000000029B1A8A0\", \"metadata\": [ { \"frequency\": 868.5, \"datarate\": \"SF8BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3143227596, \"gateway_time\": \"2016-08-03T10:28:29.08852Z\", \"channel\": 2, \"server_time\": \"2016-08-03T10:28:29.936604914Z\", \"rssi\": -72, \"lsnr\": 8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ] }","payloadType":"str","repeat":"","crontab":"","once":false,"x":170,"y":252,"wires":[["c1670e4.4955cf"]]},{"id":"1ccfe5d7.1389ca","type":"inject","z":"4c9ff67a.a5b8c8","name":"TTN test koffer 2 dicht","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"U2Vuc29yMjsw\", \"port\": 1, \"counter\": 115, \"dev_eui\": \"0000000029B1A8A0\", \"metadata\": [ { \"frequency\": 868.1, \"datarate\": \"SF8BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3139842060, \"gateway_time\": \"2016-08-03T10:28:25.703778Z\", \"channel\": 0, \"server_time\": \"2016-08-03T10:28:26.558458675Z\", \"rssi\": -72, \"lsnr\": 10.2, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ] }","payloadType":"str","repeat":"","crontab":"","once":false,"x":170,"y":292,"wires":[["c1670e4.4955cf"]]},{"id":"ef2ba629.5faf78","type":"inject","z":"4c9ff67a.a5b8c8","name":"TTN test koffer 1 open","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"U2Vuc29yMTsxOwIP\", \"port\": 1, \"counter\": 4, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.1, \"datarate\": \"SF11BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3172636156, \"gateway_time\": \"2016-08-03T10:28:58.514304Z\", \"channel\": 0, \"server_time\": \"2016-08-03T10:28:59.436321981Z\", \"rssi\": -51, \"lsnr\": 8.5, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ] }","payloadType":"str","repeat":"","crontab":"","once":false,"x":170,"y":171,"wires":[["c1670e4.4955cf"]]},{"id":"c7c7411b.5245","type":"inject","z":"4c9ff67a.a5b8c8","name":"TTN test keepalive 23 msg","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"QWxpdmUyOzIz\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"0000000029B1A8A0\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ] }","payloadType":"str","repeat":"","crontab":"","once":false,"x":179,"y":90,"wires":[["c1670e4.4955cf"]]},{"id":"47d761ae.4f291","type":"inject","z":"4c9ff67a.a5b8c8","name":"TTN test heartbeat","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"QWxpdmUyOzIz\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"0000000029B1A8A0\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ] }","payloadType":"str","repeat":"","crontab":"","once":false,"x":159,"y":332,"wires":[["c1670e4.4955cf"]]},{"id":"c1670e4.4955cf","type":"link out","z":"4c9ff67a.a5b8c8","name":"TTN test msg","links":["27ad23b4.b5636c"],"x":370.5,"y":211.29998779296875,"wires":[]},{"id":"9484d3c8.cbf12","type":"debug","z":"2acfce56.22a7b2","name":"Log Notification","active":true,"console":"false","complete":"payload","x":313.5,"y":218.29998779296875,"wires":[]},{"id":"97c9d176.caffb","type":"debug","z":"2acfce56.22a7b2","name":"","active":false,"console":"false","complete":"false","x":655.5,"y":357.29998779296875,"wires":[]},{"id":"40ad428d.77979c","type":"debug","z":"2acfce56.22a7b2","name":"","active":false,"console":"false","complete":"true","x":541.5,"y":452.29998779296875,"wires":[]},{"id":"6b348b46.902854","type":"function","z":"97f270ed.0e384","name":"Log heartbeat hum in domoticz","func":"var fields = msg.payload.fields;\nvar domoticzMsg = {};\n\nif (fields.hum === \"ER\") {\n  // Humidity error\n  return null;\n} else {\n    // voor Domoticz\n    domoticzMsg.payload = {\n        idx: 22,\n        nvalue: Number(fields.hum.split(\".\")[0]),\n        node_id: fields.node_id\n    };\n    return domoticzMsg;\n}\n","outputs":1,"noerr":0,"x":841,"y":179,"wires":[["73b7218b.1a003"]]},{"id":"73b7218b.1a003","type":"mqtt out","z":"97f270ed.0e384","name":"domoticz/in (prowl)","topic":"domoticz/in","qos":"","retain":"","broker":"1185a379.d097bd","x":1097,"y":178,"wires":[]},{"id":"6eea46fd.befa","type":"function","z":"97f270ed.0e384","name":"humidity alarm","func":"if (msg.requestPayload.fields.hum === \"ERR\" || msg.requestPayload.fields.hum === \"\") {\n    return null;\n}\n\nvar dev_eui = msg.requestPayload.dev_eui;\nvar minHumidity = Number(msg.payload[0].minhumidity);\nvar maxHumidity = Number(msg.payload[0].maxhumidity);\nvar currentHum = Number(msg.requestPayload.fields.hum);\n\ntry {\n    if (currentHum < minHumidity || currentHum > maxHumidity) {\n        return {\n            topic: \"timeout\",\n            payload: {\n                fields: {\n                    alarm: \"Luchtvochtigheid buiten range, huidige luchtvochtigheid: \" + currentHum + \"% (range: \" + minHumidity + \"% - \" + maxHumidity + \"%)\",\n                    hum: currentHum\n                },\n                dev_eui: dev_eui\n            }\n        };    \n    } else {\n        return null;\n    }\n} catch (error) {\n    // ignore non-existing or illegal humidity field errors\n    return null;\n}","outputs":1,"noerr":0,"x":1193,"y":367,"wires":[["6c76c1de.a9c9b"]]},{"id":"c6016784.f23dc8","type":"comment","z":"4c9ff67a.a5b8c8","name":"Temperature test messages","info":"","x":535.5,"y":87.44000244140625,"wires":[]},{"id":"9b751922.1d39b8","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 temp: 23 ","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"23\", \"hum\": \"\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":768,"y":35,"wires":[["1af0014f.1e32bf"]]},{"id":"1649c740.58f8b9","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 temp: ERR ","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"ERR\", \"hum\": \"\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":778,"y":73,"wires":[["1af0014f.1e32bf"]]},{"id":"ee9e2b25.f15298","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 temp: -10 ","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"-10\", \"hum\": \"\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":777,"y":112,"wires":[["1af0014f.1e32bf"]]},{"id":"3a99d289.51919e","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 temp: 150","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"150\", \"hum\": \"\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":777,"y":152,"wires":[["1af0014f.1e32bf"]]},{"id":"1af0014f.1e32bf","type":"link out","z":"4c9ff67a.a5b8c8","name":"Heartbeat test messages","links":["cf55c812.03feb8"],"x":1033.5,"y":264.29998779296875,"wires":[]},{"id":"f4ba27d1.3b0028","type":"comment","z":"4c9ff67a.a5b8c8","name":"Raw base64 test messages","info":"","x":160.5,"y":39.43999481201172,"wires":[]},{"id":"9f76ddfe.28de3","type":"comment","z":"4c9ff67a.a5b8c8","name":"Voltage test messages","info":"","x":552,"y":256,"wires":[]},{"id":"12bdad2e.6b4653","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 volt: 11.8","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"\", \"hum\": \"\", \"volt\": \"11.8\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":766.5,"y":202.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"70f6fcd9.02ec84","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 volt: ERR ","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"\", \"hum\": \"\", \"volt\": \"ERR\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":776.5,"y":240.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"a80d7f29.65e65","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 volt: 0.1","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"\", \"hum\": \"\", \"volt\": \"0.1\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":765.5,"y":279.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"e0aa0eb4.3286f","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 volt: 230","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"23\", \"hum\": \"\", \"volt\": \"230\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":765.5,"y":319.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"f649308d.1a748","type":"comment","z":"4c9ff67a.a5b8c8","name":"Humidity test messages","info":"","x":547,"y":421,"wires":[]},{"id":"661036fe.19c0b8","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 hum: 50","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"\", \"hum\": \"50\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":764.5,"y":369.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"38f3da44.3993d6","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 hum: ERR ","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"\", \"hum\": \"ERR\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":774.5,"y":407.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"4f1e7398.125a3c","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 hum: 100","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"\", \"hum\": \"100\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":773.5,"y":446.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"74f80d0e.8cea04","type":"inject","z":"4c9ff67a.a5b8c8","name":"Koffer 1 hum: 0","topic":"70B3D57ED0000105/devices/0000000029B1A8A0/up","payload":"{ \"payload\": \"Alive2;23\", \"port\": 1, \"counter\": 94, \"dev_eui\": \"000000009AA74038\", \"metadata\": [ { \"frequency\": 868.3, \"datarate\": \"SF7BW125\", \"codingrate\": \"4/5\", \"gateway_timestamp\": 3245278731, \"gateway_time\": \"2016-08-02T09:26:56.369421Z\", \"channel\": 1, \"server_time\": \"2016-08-02T09:26:58.235523738Z\", \"rssi\": -41, \"lsnr\": 9.8, \"rfchain\": 1, \"crc\": 1, \"modulation\": \"LORA\", \"gateway_eui\": \"0000024B0805026F\", \"altitude\": -1, \"longitude\": 5.26561, \"latitude\": 52.05755 } ], \"fields\": { \"msgType\": \"Alive\", \"node_id\": \"2\", \"temp\": \"\", \"hum\": \"0\", \"volt\": \"\" } }","payloadType":"json","repeat":"","crontab":"","once":false,"x":763.5,"y":486.55999755859375,"wires":[["1af0014f.1e32bf"]]},{"id":"cf55c812.03feb8","type":"link in","z":"97f270ed.0e384","name":"Heartbeat notification","links":["1af0014f.1e32bf"],"x":614.5,"y":330.1499938964844,"wires":[["e288718f.1263"]]}]